{% extends "geoflow_ops/base_tenant.html" %}
{% load static humanize %}

{% block title %}ê³„ì•½ ìƒì„¸ | GeoFlow{% endblock %}

{% block content %}
<style>.pre-wrap { white-space: pre-wrap; }</style>

<div class="mb-3 d-flex justify-content-between align-items-center">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0">
      <li class="breadcrumb-item"><a href="{% url 'tenant:contract_list' %}">ê³„ì•½ê´€ë¦¬</a></li>
      <li class="breadcrumb-item active" aria-current="page">ê³„ì•½ ìƒì„¸</li>
    </ol>
  </nav>
  <div class="d-flex gap-2">
    {% if not edit_mode %}
    <button id="btn-edit" class="btn btn-primary btn-sm">í¸ì§‘</button>
    {% endif %}
    <!-- <button id="btn-edit" class="btn btn-primary btn-sm">í¸ì§‘</button> -->
    <a href="{% url 'tenant:contract_list' %}" class="btn btn-outline-secondary btn-sm">ëª©ë¡</a>
  </div>
</div>
<!-- <div class="container-fluid px-0">
  <div class="card col-md-4 col-lg-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">ì—…ë¬´ë²”ìœ„(í”„ë¡œì íŠ¸ ì°¸ì¡°)</h5>
      <small class="text-muted">í”„ë¡œì íŠ¸ì—ì„œ ì‘ì„±í•œ ë²”ìœ„ë¥¼ ê³„ì•½ì— ì°¸ê³ í•©ë‹ˆë‹¤</small>
    </div>
    
  </div>
</div> -->

<div class="container-fluid px-0">
  <div class="row">
    
    <div class="col-md-6 col-lg-6">
      <div class="card">
        <div class="card-body">
          {# ------------------ ë³´ê¸° ëª¨ë“œ ------------------ #}
          {% if not edit_mode %}
          <div id="view-mode">
            <div class="row g-3">
              <h5 class="h6 card-title">ì¼ë°˜ì‚¬í•­</h5>
              <div class="col-md-2">
                <label class="small text-muted">ê³„ì•½ë²ˆí˜¸</label>
                <div class="form-control-plaintext">{{ obj.code|default:"-" }}</div>
              </div>
              <div class="col-md-2">
                <label class="small text-muted">ìƒíƒœ</label>
                <div class="form-control-plaintext">
                  {# 'completed'â†’'complete', 'canceled'â†’'cancel' ë§¤í•‘ í›„ ë°°ì§€ ë Œë” #}
                  {% with s=obj.status|default:""|lower %}
                    {% if s == "completed" %}
                      {% with ss="complete" %}
                        <span class="gf-status" data-render="badge" data-status="{{ ss }}"></span>
                      {% endwith %}
                    {% elif s == "canceled" %}
                      {% with ss="cancel" %}
                        <span class="gf-status" data-render="badge" data-status="{{ ss }}"></span>
                      {% endwith %}
                    {% else %}
                      <span class="gf-status" data-render="badge" data-status="{{ s }}"></span>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
              
              <div class="col-md-12">
                <label class="small text-muted">ê³„ì•½ëª…</label>
                <div class="form-control-plaintext fw-semibold">{{ obj.name|default:"-" }}</div>
              </div>


              <div class="col-md-6">
                <label class="small text-muted">ì‹œì‘ì¼</label>
                <div class="form-control-plaintext">{{ obj.start_date|date:"Y-m-d"|default:"-" }}</div>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">ì¢…ë£Œì¼</label>
                <div class="form-control-plaintext">{{ obj.end_date|date:"Y-m-d"|default:"-" }}</div>
              </div>
              <hr/>
              <h5 class="h6 card-title">ê³„ì•½ì •ë³´</h5>

              <div class="col-md-6">
                <label class="small text-muted">ê³„ì•½í˜•íƒœ</label>
                <div class="form-control-plaintext">
                  {{ obj.kind|default:"-" }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="small text-muted">ê³„ì•½ê¸ˆì•¡</label>
                <div class="form-control-plaintext">{{ obj.amount|intcomma|default:"-" }}</div>
              </div>

              <div class="col-md-6">
                <label class="small text-muted">ë°œì£¼ì²˜</label>
                <div class="form-control-plaintext">{{ obj.client.name|default:"-" }}</div>
              </div>

              {% if obj.kind == "í•˜ë„ê¸‰" %}
              <div class="col-md-6">
                <label class="small text-muted">ì›ë„ê¸‰</label>
                <div class="form-control-plaintext">{{ obj.sub_client.name|default:"-" }}</div>
              </div>
              {% endif %}

              {# ğŸ”¹ ê³„ì•½ì #}
              <div class="col-md-12">
                <label class="small text-muted">ê³„ì•½ì</label>
                <div class="form-control-plaintext">
                  {{ obj.org_unit.name|default:"-" }}
                </div>
              </div>
              <hr/>
              <h5 class="h6 card-title">ê¸°íƒ€ì •ë³´</h5>

              <div class="col-md-12">
                <label class="small text-muted">ë¹„ê³ </label>
                <div class="form-control-plaintext pre-wrap">{{ obj.description|default:"-" }}</div>
              </div>
            </div>
          </div>
          {% endif %}

          {# ------------------ í¸ì§‘ ëª¨ë“œ ------------------ #}
          {% if edit_mode %}
          <form id="edit-mode" method="post" action="{{ request.path }}" novalidate>
            {% csrf_token %}

            {% if errors %}
            <div class="alert alert-warning py-2 mb-3">
              {% for e in errors %}<div>{{ e }}</div>{% endfor %}
            </div>
            {% endif %}

            <div class="row g-3">
              <h5 class="h6 card-title">ì¼ë°˜ì‚¬í•­</h5>
              <div class="col-md-3">
                <label class="form-label">ê³„ì•½ë²ˆí˜¸ <span class="text-danger">*</span></label>
                <input type="text" name="code" class="form-control"
                      value="{{ form.code.value|default_if_none:'' }}" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">ìƒíƒœ</label>
                {% with s=form.status.value %}
                <select name="status" class="form-select">
                  <option value="">-</option>
                  <option value="planned" {% if s == "planned" %}selected{% endif %}>ê³„ì•½ì „</option>
                  <option value="active"  {% if s == "active"  %}selected{% endif %}>ì§„í–‰</option>
                  <option value="completed"    {% if s == "completed"    %}selected{% endif %}>ì™„ë£Œ</option>
                  <option value="cancel"    {% if s == "cancel"    %}selected{% endif %}>ì·¨ì†Œ</option>
                  <option value="pause"    {% if s == "pause"    %}selected{% endif %}>ì¤‘ì§€</option>
                </select>
                {% endwith %}
              </div>

              <div class="col-md-12">
                <label class="form-label">ê³„ì•½ëª… <span class="text-danger">*</span></label>
                <input type="text" name="name" class="form-control" required
                      value="{{ form.name.value|default_if_none:'' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">ì‹œì‘ì¼</label>
                <input type="text" id="start_date" name="start_date" class="form-control"
                      data-provider="flatpickr"
                      data-date-format="Y-m-d"
                      data-alt-input="true"
                      data-alt-format="Y/m/d"
                      placeholder="YYYY/MM/DD" autocomplete="off"
                      value="{{ form.instance.start_date|date:'Y-m-d' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">ì¢…ë£Œì¼</label>
                <input type="text" id="end_date" name="end_date" class="form-control"
                      data-provider="flatpickr"
                      data-date-format="Y-m-d"
                      data-alt-input="true"
                      data-alt-format="Y/m/d"
                      placeholder="YYYY-MM-DD" autocomplete="off"
                      value="{{ form.instance.end_date|date:'Y-m-d' }}">
              </div>

              <hr/>
              <h5 class="h6 card-title">ê³„ì•½ì •ë³´</h5>

              <div class="col-md-6">
                <label class="form-label">ê³„ì•½í˜•íƒœ</label>
                {% with k=form.kind.value %}
                <select id="kind" name="kind" class="form-select">
                  <option value="">-</option>
                  <option value="ì´ì•¡"   {% if k == "ì´ì•¡"   %}selected{% endif %}>ì´ì•¡ê³„ì•½</option>
                  <option value="ê³µë™"   {% if k == "ê³µë™"   %}selected{% endif %}>ê³µë™ê³„ì•½</option>
                  <option value="ì¥ê¸°ê³„ì†" {% if k == "ì¥ê¸°ê³„ì†" %}selected{% endif %}>ì¥ê¸°ê³„ì†ê³„ì•½</option>
                  <option value="ë‹¨ê°€"   {% if k == "ë‹¨ê°€"   %}selected{% endif %}>ë‹¨ê°€ê³„ì•½</option>
                  <option value="í•˜ë„ê¸‰" {% if k == "í•˜ë„ê¸‰" %}selected{% endif %}>í•˜ë„ê¸‰ê³„ì•½</option>
                </select>
                {% endwith %}
              </div>

              <div class="col-md-6">
                <label class="form-label">ê³„ì•½ê¸ˆì•¡</label>
                <input type="number" name="amount" class="form-control"
                      value="{{ form.amount.value|default_if_none:'' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">ë°œì£¼ì²˜ <span class="text-danger">*</span></label>
                <select id="client" name="client" class="form-select"
                        data-selected="{{ client_selected|default:form.client.value|default_if_none:'' }}"
                        data-choices="true" data-choices-search-true data-placeholder="ë°œì£¼ì²˜ ì„ íƒ">
                </select>
              </div>

              <div class="col-md-6
                          {% if form.kind.value != 'í•˜ë„ê¸‰' %}d-none{% endif %}"
                  id="sub_client_group">
                <label class="form-label">ì›ë„ê¸‰</label>
                <select id="sub_client" name="sub_client" class="form-select"
                        data-selected="{{ sub_client_selected|default:form.sub_client.value|default_if_none:'' }}"
                        data-choices="true" data-choices-search-true data-placeholder="ì›ë„ê¸‰ ì„ íƒ">
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">ê³„ì•½ì</label>
                {{ form.org_unit }}
              </div>
              <hr/>
              <h5 class="h6 card-title">ê¸°íƒ€ì •ë³´</h5>

              <div class="col-md-12">
                <label class="form-label">ë¹„ê³ </label>
                <textarea name="description" rows="4" class="form-control">{{ form.description.value|default_if_none:'' }}</textarea>
              </div>
            </div>

            <div class="mt-4 d-flex gap-2">
              <button class="btn btn-primary" type="submit">ì €ì¥</button>

              {# ìƒì„± ëª¨ë“œ(force_create=True)ë©´ ëª©ë¡ìœ¼ë¡œ, ì•„ë‹ˆë©´ ìƒì„¸ë¡œ #}
              {% if force_create %}
                <a href="{% url 'tenant:contract_list' %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
              {% else %}
                {% if form.instance and form.instance.id %}
                  <a href="{% url 'tenant:contract_detail' pk=form.instance.id %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
                {% else %}
                  <a href="{% url 'tenant:contract_list' %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
                {% endif %}
              {% endif %}
            </div>

          </form>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-3 col-lg-3">
      <div class="card">
    <!-- <div class="card-header">
      <h5 class="card-title mb-0">{{ obj.name|default:"-" }}</h5>
    </div> -->
    <!-- <hr/> -->
        <div class="card-body">
          <h5 class="h6 card-title">ì—…ë¬´ë²”ìœ„</h5>

          {% if project_for_scope %}
            {% if scope_groups and scope_groups|length %}

              <!-- ===== L1 íƒ­ ì˜ì—­ ===== -->
              <ul class="nav nav-tabs" id="scopeTabs" role="tablist">
                {% for g in scope_groups %}
                  <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}"
                            id="tab-btn-{{ g.l1_code }}"
                            data-bs-toggle="tab"
                            data-bs-target="#tab-{{ g.l1_code }}"
                            type="button"
                            role="tab">
                      {{ g.l1_name }}
                    </button>
                  </li>
                {% endfor %}
              </ul>

              <!-- ===== íƒ­ë³„ ì»¨í…ì¸  ì˜ì—­ ===== -->
              <div class="tab-content mt-3" id="scopeTabsContent">
                {% for g in scope_groups %}
                  <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                      id="tab-{{ g.l1_code }}"
                      role="tabpanel">

                    {% for b in g.l2_blocks %}
                      <div class="mb-2">
                        <div class="text-body mb-1 small">{{ b.l2_name }}</div>

                        <div class="table-responsive">
                          <table class="table table-sm align-middle mb-2">
                            <tbody>
                              {% for r in b.rows %}
                                <tr>
                                  <td style="width:50%">{{ r.l3_name }}</td>

                                  <td class="text-end" style="width:25%">
                                    <span>{{ r.design_display|default:r.design_qty|default:"-" }}</span>
                                    <span class="small">{{ r.unit|default:"-" }}</span>
                                  </td>

                                  <td class="text-end" style="width:25%">
                                    {{ r.completed_display|default:r.completed_qty|default:"-" }}
                                  </td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>

                      </div>
                    {% endfor %}

                  </div>
                {% endfor %}
              </div>

            {% else %}
              <div class="text-muted small">í‘œì‹œí•  ì—…ë¬´ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
          {% else %}
            <div class="text-muted small">ì—°ê²°ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'geoflow_ops/js/scope-linker.js' %}"></script>
<script src="{% static 'geoflow_ops/js/gf-list-core.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // 1) ìƒì„¸í˜ì´ì§€ ë°°ì§€ ê°•ì œ ë Œë” (ìƒíƒœ ë±ƒì§€ í‘œì‹œ)
  if (window.GeoFlowListCore && GeoFlowListCore.renderBadges) {
    GeoFlowListCore.renderBadges(document);
  }

  // 2) í¸ì§‘ ë²„íŠ¼ (?edit=1)
  var btn = document.getElementById("btn-edit");
  if (btn) {
    btn.addEventListener("click", function () {
      var url = new URL(window.location.href);
      url.searchParams.set("edit", "1");
      window.location.assign(url.toString());
    });
  }

  // Choices ì´ˆê¸°í™”(í•œ ë²ˆë§Œ)
  function initChoicesOnce(sel){
    if (!sel) return;
    if (sel.dataset.choicesInited === "1") return;
    sel.dataset.choicesInited = "1";
    if (window.Choices) {
      // AdminKit Proê°€ ìë™ ì´ˆê¸°í™”ë¥¼ ëª» ì¡ì•˜ì„ ë•Œ ìˆ˜ë™ ì´ˆê¸°í™”
      new Choices(sel, {
        searchEnabled: true,
        shouldSort: false,
        itemSelectText: "",
        removeItemButton: false,
        placeholder: true,
        placeholderValue: sel.getAttribute("data-placeholder") || ""
      });
    }
  }

  // ===== í¸ì§‘ ëª¨ë“œ ì „ìš©: íŒŒíŠ¸ë„ˆ ì˜µì…˜ ì±„ìš°ê¸° =====
  var clientSel  = document.getElementById("client");
  var subSel     = document.getElementById("sub_client");
  var kindSel    = document.getElementById("kind");
  var subGroup   = document.getElementById("sub_client_group");

  if (clientSel || subSel) {
    fetch("{% url 'tenant:partner_options' %}?limit=500")
      .then(function(r){ return r.json(); })
      .then(function(data){
        var items = (data.results || data || []);
        // íšŒì‚¬ëª… ì •ë ¬ (gf-list-core ìœ í‹¸ì´ ìˆìœ¼ë©´ ì‚¬ìš©)
        if (window.GeoFlow && GeoFlow.utils && GeoFlow.utils.sortOptionsByCompany) {
          items = GeoFlow.utils.sortOptionsByCompany(items);
        }
        // ê³µí†µ ë¡œë”
        function fillSelect(sel){
          if (!sel) return;
          var selected = sel.getAttribute("data-selected") || "";
          sel.innerHTML = '<option value="">-</option>';
          items.forEach(function(it){
            var opt = document.createElement("option");
            opt.value = it.id;
            opt.textContent = it.text || it.name || "";
            if (selected && String(selected) === String(it.id)) opt.selected = true;
            sel.appendChild(opt);
          });
          // ì˜µì…˜ ì±„ìš´ ì§í›„ ê²€ìƒ‰ í™œì„±í™”(1íšŒ)
          initChoicesOnce(sel);
        }
        fillSelect(clientSel);
        fillSelect(subSel);
      })
      .catch(function(){ /* ë¬´ì‹œ(ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±) */ });
  }

  // í•˜ë„ê¸‰ ì„ íƒ ì‹œ ì›ë„ê¸‰ ì˜ì—­ í† ê¸€
  function toggleSub(){
    if (!kindSel || !subGroup) return;
    var v = (kindSel.value || "").trim();
    if (v === "í•˜ë„ê¸‰") {
      subGroup.classList.remove("d-none");
      // ë…¸ì¶œ ìˆœê°„ì—ë„ ê²€ìƒ‰ UIê°€ ë³´ì¥ë˜ë„ë¡
      initChoicesOnce(subSel);
    } else {
      subGroup.classList.add("d-none");
    }
  }
  if (kindSel) {
    kindSel.addEventListener("change", toggleSub);
    toggleSub();
  }
});
</script>
{% endblock %}

