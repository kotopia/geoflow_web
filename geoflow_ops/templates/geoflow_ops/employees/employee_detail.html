{% extends "geoflow_ops/base_tenant.html" %}
{% load static acl_tags %}

{% block title %}구성원 상세{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">구성원 상세</h1>
    <div class="d-flex gap-2">
      {% if not create_mode and edit_mode != True %}
        {% has_perm 'directory.edit' as can_manage %}
        {% if can_manage %}
          <button id="btn-edit" class="btn btn-primary btn-sm">편집</button>
        {% endif %}
      {% endif %}
      <a href="{% url 'tenant:employees_list' %}" class="btn btn-outline-secondary btn-sm">목록</a>
    </div>
  </div>

  {# === 좌우 2컬럼 레이아웃 시작 === #}
  <div class="row g-3">

    {# ───────────────────── 좌측: Profile Details 사이드 카드 ───────────────────── #}
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">Profile Details</h5>
        </div>

        <div class="card-body text-center">
          {# 아바타: AdminKit 정적 리소스 사용(원하면 DiceBear 유지 가능) #}
          <img src="{% static 'control/img/avatars/avatar-4.jpg' %}"
              alt="Profile" class="img-fluid rounded-circle mb-2" width="64" height="64" />
          <h5 class="card-title mb-0">{{ profile.name|default:"(이름 없음)" }}</h5>
        </div>
        <div class="card-body">
          <!-- <h5 class="h6 card-title">About</h5> -->
          <ul class="list-unstyled mb-0">
            <li class="mb-1"><span data-feather="briefcase" class="feather-sm me-1"></span>
              {% with id=profile.org_unit_id %}
                    {% for ou in org_units %}
                      {% if ou.id == id %}{{ ou.name }}{% endif %}
                    {% endfor %}
                  {% endwith %}
            </li>
            <li class="mb-1">
              <span data-feather="info" class="feather-sm me-1"></span> {{ profile.title|default:"-" }}
              <span class="small">(5년 2개월)</span>
            </li>
            <li class="mb-1 "><span data-feather="phone" class="feather-sm me-1"></span> {{ profile.phone|default:"-" }}</li>
            <li class="mb-1"><span data-feather="mail" class="feather-sm me-1"></span> {{ profile.email }}</li>
          </ul>
        </div>

        <hr class="my-0" />
        <div class="card-body">
          <h5 class="h6 card-title">License</h5>
          <a href="#" class="badge bg-primary me-1 my-1">정보처리기사</a>
          <a href="#" class="badge bg-primary me-1 my-1">지도제작기능사</a>
          <a href="#" class="badge bg-primary me-1 my-1">운전면허증</a>
          <a href="#" class="badge bg-success me-1 my-1">초급기술자</a>
          <a href="#" class="badge bg-success me-1 my-1">초급기능사</a>
        </div>

        <hr class="my-0" />
        <div class="card-body">
          <h5 class="h6 card-title">About</h5>
          <ul class="list-unstyled mb-0">
            <li class="mb-1"><span data-feather="home" class="feather-sm me-1"></span> 대전광역시 서구 관저동로12, 103동 801호</li>
            <li class="mb-1"><span data-feather="info" class="feather-sm me-1"></span> {{ profile.rrn_masked|default:"(없음)" }}</li>
            <li class="mb-1"><span data-feather="phone" class="feather-sm me-1"></span> {{ profile.phone|default:"-" }}</li>
          </ul>
        </div>

        <hr class="my-0" />
        <div class="card-body">
          <h5 class="h6 card-title">Elsewhere</h5>
          <ul class="list-unstyled mb-0">
            <li class="mb-1"><span class="fas fa-globe fa-fw me-1"></span> <a href="#">staciehall.co</a></li>
            <li class="mb-1"><span class="fab fa-twitter fa-fw me-1"></span> <a href="#">Twitter</a></li>
            <li class="mb-1"><span class="fab fa-facebook fa-fw me-1"></span> <a href="#">Facebook</a></li>
            <li class="mb-1"><span class="fab fa-instagram fa-fw me-1"></span> <a href="#">Instagram</a></li>
            <li class="mb-1"><span class="fab fa-linkedin fa-fw me-1"></span> <a href="#">LinkedIn</a></li>
          </ul>
        </div>
      </div>
    </div>

    {# ───────────────────── 우측: 기존 상세/편집 메인 카드 ───────────────────── #}
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          {# -------------------- 보기 모드 -------------------- #}
          {% if not create_mode and not edit_mode %}
          <div id="view-mode">
            <div class="row g-4 mb-3">
              <div class="card-header">
                <h5 class="card-title mb-0">기본정보</h5>
              </div>
              <div class="col-md-12">
                <!-- <div class="col-md-3">
                  <div class="d-flex align-items-center gap-3">
                    <img src="{% static 'control/img/avatars/avatar-4.jpg' %}"
                         alt="Profile" class="img-fluid rounded mb-2" width="128" height="128" />
                  </div> -->
                  <!-- <div>
                    <label class="form-label small">성명</label>
                    <span class="fw-bold mb-1">{{ profile.name|default:"(이름 없음)" }}</span>
                    <span>
                      {# 보기 모드의 상태 배지 분기 #}
                      {% if profile.status == 'active' or profile.status == '재직' %}
                        <span class="badge bg-success">재직</span>
                      {% elif profile.status == '휴직' or profile.status == 'leave' %}
                        <span class="badge bg-warning text-dark">휴직</span>
                      {% elif profile.status == '퇴사' or profile.status == 'terminated' or profile.status == 'inactive' %}
                        <span class="badge bg-secondary">퇴사</span>
                      {% else %}
                        <span class="badge bg-light text-dark">{{ profile.status|default:"-" }}</span>
                      {% endif %}
                    </span>
                  </div> -->
                  <!-- <div>
                    <label class="form-label small">이메일</label>
                    <span class="fw-bold mb-1">{{ profile.email }}</span>
                  </div> -->
                <!-- </div> -->

                <div class="col-md-12">
                  <div class="row">
                    <div class="col-6 mb-2">
                      <table class="table table-sm align-middle">
                        <tbody>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">성명</td>
                              <td style="width:70%;">{{ profile.name|default:"(이름 없음)" }}</td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">주민번호</td>
                              <td style="width:70%;">{{ profile.rrn_masked|default:"(없음)" }}</td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">전화번호</td>
                              <td style="width:70%;">{{ profile.phone|default:"-" }}</td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">이메일</td>
                              <td style="width:70%;">{{ profile.email }}</td>
                            </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="col-6 mb-2">
                      <table class="table table-sm align-middle">
                        <tbody>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">본사/지점</td>
                              <td style="width:70%;">
                                {% with id=profile.org_unit_id %}
                                  {% for ou in org_units %}
                                    {% if ou.id == id %}{{ ou.name }}{% endif %}
                                  {% endfor %}
                                {% endwith %}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">입사일</td>
                              <td style="width:70%;">{{ profile.hire_date|date:"Y-m-d"|default:"-" }}</td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">사번</td>
                              <td style="width:70%;">{{ profile.emp_no|default:"-" }}</td>
                            </tr>
                            <tr>
                              <td class="text-center text-muted small" style="width:10%;">고용형태</td>
                              <td style="width:70%;">{{ profile.emp_type|default:"-" }}</td>
                            </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">성명</div>
                      <div class="form-control-plaintext">{{ profile.name|default:"(이름 없음)" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">사번</div>
                      <div class="form-control-plaintext">{{ profile.emp_no|default:"-" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">본사/지점</div>
                      <div class="form-control-plaintext">
                        {% with id=profile.org_unit_id %}
                          {% for ou in org_units %}
                            {% if ou.id == id %}{{ ou.name }}{% endif %}
                          {% endfor %}
                        {% endwith %}
                      </div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">부서</div>
                      <div class="form-control-plaintext">
                        {% with id=profile.department_id %}
                          {% for d in departments %}
                            {% if d.id == id %}{{ d.name }}{% endif %}
                          {% endfor %}
                        {% endwith %}
                      </div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">고용형태</div>
                      <div class="form-control-plaintext">{{ profile.emp_type|default:"-" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">상태</div>
                      <div class="form-control-plaintext">{{ profile.status|default:"-" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">직급</div>
                      <div class="form-control-plaintext">{{ profile.title|default:"-" }}</div>
                    </div>
                    <div class="col-3 mb-2">
                      <div class="text-muted small">입사일</div>
                      <div class="form-control-plaintext">{{ profile.hire_date|date:"Y-m-d"|default:"-" }}</div>
                    </div>
                    {# 보기 모드에서는 ‘퇴사’ 상태일 때만 퇴사일 노출 #}
                    {% if profile.status == '퇴사' %}
                    <div class="col-3 mb-2">
                      <div class="text-muted small">퇴사일</div>
                      <div class="form-control-plaintext">{{ profile.term_date|date:"Y-m-d"|default:"-" }}</div>
                    </div>
                    {% endif %}
                    <div class="col-6 mb-2">
                      <div class="text-muted small">이메일</div>
                      <div class="form-control-plaintext">{{ profile.email }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">전화</div>
                      <div class="form-control-plaintext">{{ profile.phone|default:"-" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">주민번호</div>
                      <div class="form-control-plaintext">{{ profile.rrn_masked|default:"(없음)" }}</div>
                    </div>
                    <div class="col-6 mb-2">
                      <div class="text-muted small">주소</div>
                      <div class="form-control-plaintext">대전광역시 서구 관저동로12, 103동 801호</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {# -------------------- 편집 모드 -------------------- #}
          {% if edit_mode %}
          <form id="edit-mode" method="post" action="">
            {% csrf_token %}
            {% has_perm 'directory.edit' as can_manage %}
            {% if can_manage or create_mode %}
            <!-- <hr> -->
            <div class="row g-3">
              {# 섹션 1: 기본정보 #}
              <div class="col-12">
                <div class="h6 mb-2">기본정보</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">이메일</label>
                <input type="email" name="email" value="{{ profile.email }}" class="form-control" {% if not create_mode %}readonly{% endif %}>
              </div>
              <div class="col-md-4">
                <label class="form-label">이름</label>
                <input type="text" name="name" value="{{ profile.name }}" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">전화</label>
                <input type="text" name="phone" value="{{ profile.phone }}" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">직함</label>
                <input type="text" name="title" value="{{ profile.title }}" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">역할 코드</label>
                <input type="text" name="role_code" value="{{ profile.role_code }}" class="form-control">
              </div>
              <!-- <div class="col-md-4">
                <label class="form-label">상태</label>
                <input type="text" name="status" value="{{ profile.status|default:'active' }}" class="form-control">
              </div> -->

              {# 섹션 2: 조직  ==> 여기에서 'select' 로 입력/저장 #}
              <div class="col-12 mt-2">
                <div class="h6 mb-2">조직</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">본사/지점</label>
                <select name="org_unit_id" id="org_unit_select" class="form-select">
                  <option value="">- 선택 -</option>
                  {% for ou in org_units %}
                    <option value="{{ ou.id }}" {% if ou.id == profile.org_unit_id %}selected{% endif %}>
                      {{ ou.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">부서</label>
                <select name="department_id" id="dept_select" class="form-select">
                  <option value="">- 선택 -</option>
                  {% for d in departments %}
                    <option value="{{ d.id }}" {% if d.id == profile.department_id %}selected{% endif %}>
                      {{ d.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">직속 관리자</label>
                <select name="manager_id" class="form-select">
                  <option value="">- 선택 -</option>
                  {% for m in managers %}
                    <option value="{{ m.id }}" {% if m.id == profile.manager_id %}selected{% endif %}>
                      {{ m.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              {# 섹션 3: 인사정보 #}
              <div class="col-12 mt-2">
                <div class="h6 mb-2">인사정보</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">직급</label>
                <select name="position_grade" id="position_grade" class="form-select">
                  <option value="">- 선택 -</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">고용형태</label>
                <select name="emp_type" id="employment_type" class="form-select">
                  <option value="">- 선택 -</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">사번</label>
                <input type="text" name="emp_no" value="{{ profile.emp_no }}" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="form-label">입사일</label>
                <input type="date" name="hire_date" value="{{ profile.hire_date|date:'Y-m-d' }}" class="form-control">
              </div>

              <div class="col-md-4" id="term_date_wrap">
                <label class="form-label">퇴사일</label>
                <input type="date" name="term_date" value="{{ profile.term_date|date:'Y-m-d' }}" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="form-label">상태</label>
                <select name="status" id="hr_status" class="form-select">
                  <option value="">- 선택 -</option>
                </select>
              </div>

              {# 섹션 4: 주민번호(보안) #}
              <div class="col-12 mt-2">
                <div class="h6 mb-2">주민등록번호</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">저장된 값</label>
                <input type="text" class="form-control" value="{{ profile.rrn_masked|default:'(없음)' }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">새로 입력(저장 시 암호화/해시)</label>
                <input
                  type="text"
                  name="rrn_plain"
                  id="rrn_plain"
                  class="form-control"
                  placeholder="숫자만 입력하세요"
                  inputmode="numeric"
                  pattern="^\d{6}-?\d{7}$"
                  maxlength="14"
                  autocomplete="off"
                >
                <div class="form-text">입력 시 6자리 뒤에 하이픈이 자동 입력됩니다. 저장은 숫자만 보관합니다.</div>
              </div>
            </div>

            <div class="mt-3 text-end">
              <button class="btn btn-primary btn-sm">저장</button>
              <a href="{% url 'tenant:employees_list' %}" class="btn btn-outline-secondary btn-sm">취소</a>
            </div>

            {% endif %}
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# 하단에 스크립트 추가(페이지 내) #}
{% block scripts %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // 계약 상세와 동일: 편집 버튼이 있으면 ?edit=1 로 이동
  var btn = document.getElementById("btn-edit");
  if (btn) {
    btn.addEventListener("click", function () {
      var url = new URL(window.location.href);
      url.searchParams.set("edit", "1");
      window.location.assign(url.toString());
    });
  }
});
</script>

<script>
(function(){
  var el = document.getElementById("rrn_plain");
  if(!el) return;
  el.addEventListener("input", function(){
    var digits = (this.value || "").replace(/\D/g, ""); // 숫자만
    if (digits.length <= 6) {
      this.value = digits;
    } else {
      this.value = digits.slice(0,6) + "-" + digits.slice(6,13); // 최대 13자리
    }
  });
})();
</script>

<script>
(function(){
  function fillSelect(sel, items, selected){
    sel.innerHTML = '<option value="">- 선택 -</option>';
    items.forEach(function(it){
      var opt = document.createElement('option');
      opt.value = it.id;
      opt.textContent = it.text;
      if(selected && String(selected) === String(it.id)) opt.selected = true;
      sel.appendChild(opt);
    });
  }
  function loadOptions(category, sel, selected){
    fetch("{% url 'tenant:hr_options' 'REPLACE' %}".replace('REPLACE', category))
      .then(function(r){ return r.json(); })
      .then(function(data){ fillSelect(sel, data.results || [], selected); })
      .catch(function(){ /* no-op */ });
  }

  // 초기 선택값(서버가 내려준 기존 값)
  var initGrade  = "{{ profile.position_grade|default_if_none:'' }}";
  var initType   = "{{ profile.emp_type|default_if_none:'' }}";
  var initStatus = "{{ profile.status|default_if_none:'' }}";

  var gradeSel = document.getElementById("position_grade");
  var typeSel  = document.getElementById("employment_type");
  var statSel  = document.getElementById("hr_status");
  var termWrap = document.getElementById("term_date_wrap");

  if(gradeSel) loadOptions("position_grade", gradeSel, initGrade);
  if(typeSel)  loadOptions("employment_type", typeSel, initType);
  if(statSel)  loadOptions("status", statSel, initStatus);

  function syncTermDateVisibility(){
    var val = statSel ? statSel.value : "";
    // 상태가 '퇴사'일 때만 보이기
    if(termWrap){
      if(val === "퇴사"){ termWrap.style.display = ""; }
      else { termWrap.style.display = "none"; }
    }
  }
  document.addEventListener("DOMContentLoaded", syncTermDateVisibility);
  if(statSel) statSel.addEventListener("change", syncTermDateVisibility);
  // 최초 1회 상태 값에 따라 반영
  syncTermDateVisibility();
})();
</script>
{% endblock scripts %}